import com.sun.j3d.utils.applet.MainFrame;
import com.sun.j3d.utils.universe.SimpleUniverse;
import java.applet.Applet;
import java.awt.BorderLayout;
import java.awt.Panel;
import java.awt.event.ActionEvent;
import java.awt.event.ActionListener;
import java.awt.event.KeyEvent;
import java.awt.event.KeyListener;
import javax.media.j3d.Appearance;
import javax.media.j3d.BranchGroup;
import javax.media.j3d.Canvas3D;
import javax.media.j3d.Transform3D;
import javax.swing.JCheckBox;
import javax.swing.JLabel;
import javax.swing.JTextArea;
import javax.swing.Timer;
import javax.vecmath.Point3d;
import javax.vecmath.Vector3d;

/**
 *
 * @author Alya Carina
 */
public class ParticleSystemViewer extends Applet {

    private GeneralParticles squareSystem;
    private PointParticles pointSystem;
    private BranchGroup particleNode, allFather;
    private JCheckBox pointParticles_check, squareParticles_check;
    private JTextArea numParticles_point, numParticles_general, particleSize;
    private boolean squares, points;
    private int np_point, np_general;
    private float ps;

    public ParticleSystemViewer() {
        setLayout(new BorderLayout());

        points = false;
        squares = false;
        np_point = 100;
        np_general = 100;
        ps = 0.05f;

        Canvas3D viewPort = new Canvas3D(SimpleUniverse.getPreferredConfiguration());
        SimpleUniverse homeOf3D = new SimpleUniverse(viewPort);

        Point3d eye = new Point3d(1.0, -1.0, 2.0);
        Point3d center = new Point3d(0.0, 1.0, 0.0);
        Vector3d up = new Vector3d(0.0, 1.0, 0.0);
        Transform3D lookAt = new Transform3D();
        lookAt.lookAt(eye, center, up);
        lookAt.invert();
        homeOf3D.getViewingPlatform().getViewPlatformTransform().setTransform(lookAt);

        allFather = new BranchGroup();
        allFather.setCapability(BranchGroup.ALLOW_CHILDREN_WRITE);
        allFather.setCapability(BranchGroup.ALLOW_CHILDREN_EXTEND);
        
        particleNode = new BranchGroup();
        particleNode.setCapability(BranchGroup.ALLOW_DETACH);
        
        SampleSquare sq1 = new SampleSquare(ps, new Appearance());
        squareSystem = new GeneralParticles(np_general, sq1.getSquare());
        //particleNode.addChild(squareSystem.getBranchGraph());
        
        pointSystem = new PointParticles(np_point, new Appearance());
        //particleNode.addChild(pointSystem.getBranchGraph());
        
        allFather.addChild(particleNode);
        homeOf3D.addBranchGraph(allFather);

        Timer dimension4 = new Timer(80, new ActionListener() {
            @Override
            public void actionPerformed(ActionEvent ae) {
                particleNode.detach();
                particleNode.removeAllChildren();
                if (squares) {
                    squareSystem.brownianMotion_OneStep(0.05, 0.001);                                        
                    particleNode.addChild(squareSystem.getBranchGraph());
                } 
                if (points) {
                    pointSystem.brownianMotion_OneStep(0.01);                                        
                    particleNode.addChild(pointSystem.toShape());
                }
                allFather.addChild(particleNode);
            }
        });

        dimension4.start();

        add("Center", viewPort);

        Panel chooseParticles = new Panel();
        
        JLabel numParticles_label_point = new JLabel("Number of PointParticles:");
        numParticles_point = new JTextArea("100", 1, 4);
        numParticles_point.addKeyListener(new KeyListener(){
            @Override
            public void keyTyped(KeyEvent ke) {
                if (ke.getKeyCode() == KeyEvent.VK_ENTER) {
                    String text = numParticles_point.getText();
                    numParticles_point.setText(text.substring(0, text.length()-1));
                    numParticles_point.setCaretPosition(0);
                }
            }

            @Override
            public void keyPressed(KeyEvent ke) {
                if (ke.getKeyCode() == KeyEvent.VK_ENTER) {
                    try {
                        np_point = Integer.parseInt(numParticles_point.getText());
                    
                        pointSystem = new PointParticles(np_point, new Appearance());
                        //particleNode.addChild(pointSystem.getBranchGraph());
                        
                    } catch(Exception e) {
                        numParticles_point.setText(np_point + " ");
                        pointSystem = new PointParticles(np_point, new Appearance());
                    }
                }
            }

            @Override
            public void keyReleased(KeyEvent ke) {
                if (ke.getKeyCode() == KeyEvent.VK_ENTER) {
                    String text = numParticles_point.getText();
                    numParticles_point.setText(text.substring(0, text.length()-1));
                    numParticles_point.setCaretPosition(0);
                }
            }
        });
        
        JLabel numParticles_label_general = new JLabel("Number of GeneralParticles:");
        numParticles_general = new JTextArea("100", 1, 4);
        numParticles_general.addKeyListener(new KeyListener(){
            @Override
            public void keyTyped(KeyEvent ke) {
                if (ke.getKeyCode() == KeyEvent.VK_ENTER) {
                    String text = numParticles_general.getText();
                    numParticles_general.setText(text.substring(0, text.length()-1));
                    numParticles_general.setCaretPosition(0);
                }
            }

            @Override
            public void keyPressed(KeyEvent ke) {
                if (ke.getKeyCode() == KeyEvent.VK_ENTER) {
                    try {
                        np_general = Integer.parseInt(numParticles_general.getText());
                        SampleSquare sqn = new SampleSquare(ps, new Appearance());
                        squareSystem = new GeneralParticles(np_general, sqn.getSquare());
                        //particleNode.addChild(squareSystem.getBranchGraph());
                        
                    } catch(Exception e) {
                        numParticles_general.setText(np_general + " ");
                        SampleSquare sqn = new SampleSquare(ps, new Appearance( ));
                        squareSystem = new GeneralParticles(np_general, sqn.getSquare());
                    }
                }
            }

            @Override
            public void keyReleased(KeyEvent ke) {
                if (ke.getKeyCode() == KeyEvent.VK_ENTER) {
                    String text = numParticles_general.getText();
                    numParticles_general.setText(text.substring(0, text.length()-1));
                    numParticles_general.setCaretPosition(0);
                }
            }
        });

        pointParticles_check = new JCheckBox("Point Particles");
        pointParticles_check.addActionListener(new ActionListener() {
            @Override
            public void actionPerformed(ActionEvent ae) {
                    points  = pointParticles_check.isSelected();
            }
        });

        squareParticles_check = new JCheckBox("Square Particles");
        squareParticles_check.addActionListener(new ActionListener() {
            @Override
            public void actionPerformed(ActionEvent ae) {
                    squares  = squareParticles_check.isSelected();
            }
        });
        
        JLabel particleSize_label = new JLabel("Particle Size:");
        particleSize = new JTextArea("0.05", 1 , 4);
        particleSize.addKeyListener(new KeyListener(){
            @Override
            public void keyTyped(KeyEvent ke) {
                if (ke.getKeyCode() == KeyEvent.VK_ENTER) {
                    String text = particleSize.getText();
                    particleSize.setText(text.substring(0, text.length()-1));
                    particleSize.setCaretPosition(0);
                }
            }

            @Override
            public void keyPressed(KeyEvent ke) {
                if (ke.getKeyCode() == KeyEvent.VK_ENTER) {
                    try {
                        ps = Float.parseFloat(particleSize.getText());
                        SampleSquare sqn = new SampleSquare(ps, new Appearance());
                        squareSystem = new GeneralParticles(np_general, sqn.getSquare());
                        //particleNode.addChild(squareSystem.getBranchGraph());
                        
                    } catch(Exception e) {
                        particleSize.setText(ps + " ");
                        SampleSquare sqn = new SampleSquare(ps, new Appearance());
                        squareSystem = new GeneralParticles(np_general, sqn.getSquare());
                    }
                }
            }

            @Override
            public void keyReleased(KeyEvent ke) {
                if (ke.getKeyCode() == KeyEvent.VK_ENTER) {
                    String text = particleSize.getText();
                    particleSize.setText(text.substring(0, text.length()-1));
                    particleSize.setCaretPosition(0);
                }
            }        
        });

        chooseParticles.add(numParticles_label_point);
        chooseParticles.add(numParticles_point);
        chooseParticles.add(numParticles_label_general);
        chooseParticles.add(numParticles_general);
        chooseParticles.add(pointParticles_check);
        chooseParticles.add(squareParticles_check);
        chooseParticles.add(particleSize_label);
        chooseParticles.add(particleSize);

        add("South", chooseParticles);
    }

    public static void main(String[] args) {
        MainFrame mf = new MainFrame(new ParticleSystemViewer(), 500, 500);
        mf.setTitle("Particle System Viewer: Brownian Motion");
    }
}
